#!/bin/bash

# Real-time Fallback Debugging - Step by Step Guide
echo "ğŸ” FiqhAdvisor Real-time Debugging Guide"
echo "========================================"
echo ""

echo "ğŸ“± STEP 1: Prepare Your Environment"
echo "-----------------------------------"
echo "1. Connect your Android device/emulator"
echo "2. Enable USB Debugging"
echo "3. Run: adb devices"
echo ""
read -p "âœ… Device connected? Press Enter to continue..."

echo ""
echo "ğŸ§¹ STEP 2: Clear Logs and Start Monitoring"
echo "------------------------------------------"
echo "Run this command in your terminal:"
echo ""
echo "adb logcat -c && adb logcat -v time | grep -E \"(FiqhAIViewModel|FiqhAIManager|ğŸ”|âœ…|âŒ|âš ï¸|ğŸ’¥|System not initialized|Native library)\" --color=always"
echo ""
read -p "âœ… Monitoring started? Press Enter to continue..."

echo ""
echo "ğŸ—ï¸ STEP 3: Build and Install App"
echo "--------------------------------"
echo "Run these commands:"
echo ""
echo "cd /mnt/d/Engineer/web3/rizilab/fiqhadvisor/android"
echo "./gradlew installDebug"
echo ""
read -p "âœ… App installed? Press Enter to continue..."

echo ""
echo "ğŸš€ STEP 4: Launch App"
echo "--------------------"
echo "Run this command:"
echo ""
echo "adb shell am start -n com.rizilab.fiqhadvisor/.MainActivity"
echo ""
echo "ğŸ‘€ Watch your monitoring terminal for startup messages!"
echo ""
read -p "âœ… App launched? Press Enter to continue..."

echo ""
echo "ğŸ§ª STEP 5: Test AI Query"
echo "-----------------------"
echo "1. In the app, go to the chat interface"
echo "2. Type a test query like: 'Bitcoin'"
echo "3. Send the message"
echo ""
echo "ğŸ‘€ Watch your monitoring terminal for these key messages:"
echo ""
echo "âœ… SUCCESS INDICATORS:"
echo "   - ğŸ” Analyzing token: Bitcoin"
echo "   - âœ… System initialized, calling fiqhManager.analyzeToken()"
echo "   - âœ… Token analysis successful for Bitcoin"
echo ""
echo "âŒ FAILURE INDICATORS:"
echo "   - âš ï¸ System not initialized, providing fallback response"
echo "   - âŒ Failed to initialize AI system"
echo "   - UnsatisfiedLinkError or library loading errors"
echo ""
read -p "âœ… Query tested? Press Enter to continue..."

echo ""
echo "ğŸ“Š STEP 6: Analyze Results"
echo "-------------------------"
echo "Based on what you saw in the logs, identify the issue:"
echo ""
echo "ğŸŸ¢ If you saw 'âœ… Token analysis successful':"
echo "   â†’ AI system is working! The issue might be elsewhere."
echo ""
echo "ğŸŸ¡ If you saw 'âš ï¸ System not initialized':"
echo "   â†’ FiqhAIManager initialization is failing."
echo "   â†’ Check for initialization error messages."
echo ""
echo "ğŸ”´ If you saw 'UnsatisfiedLinkError' or library errors:"
echo "   â†’ Native library (libfiqh_core.so) is not loading."
echo "   â†’ Check APK contents and build configuration."
echo ""
echo "ğŸ”µ If you saw no FiqhAIViewModel messages at all:"
echo "   â†’ The ViewModel might not be getting called."
echo "   â†’ Check UI integration and method calls."
echo ""

echo ""
echo "ğŸ” STEP 7: Specific Issue Commands"
echo "---------------------------------"
echo ""
echo "For Native Library Issues:"
echo "adb logcat | grep -E \"(library|JNI|uniffi|libfiqh_core|UnsatisfiedLinkError)\""
echo ""
echo "For Initialization Issues:"
echo "adb logcat | grep -E \"(FiqhAIManager|initialization|failed|System not initialized)\""
echo ""
echo "For UniFFI Issues:"
echo "adb logcat | grep -E \"(uniffi|rust|binding)\""
echo ""
echo "For Recent Errors:"
echo "adb logcat -d | grep -E \"(ERROR|FATAL)\" | grep -i fiqh | tail -10"
echo ""

echo ""
echo "ğŸ“ STEP 8: Save Logs for Analysis"
echo "--------------------------------"
echo "To save logs for detailed analysis:"
echo ""
echo "adb logcat -d > fiqhadvisor_debug_$(date +%Y%m%d_%H%M%S).log"
echo ""
echo "This saves all recent logs to a file for review."
echo ""

echo ""
echo "ğŸ¯ READY TO START!"
echo "=================="
echo "1. Open a terminal and run the monitoring command from Step 2"
echo "2. Follow steps 3-6 while watching the monitoring output"
echo "3. Report back what you see in the logs!"
echo ""
echo "The key is to watch for the emoji indicators (ğŸ”âœ…âŒâš ï¸ğŸ’¥) that will show"
echo "exactly where the process is failing."